services:
  nginx:
    build:
      context: .
      args:
        VERSION: ${VERSION:-1.29.3}
        SHA256: ${SHA256:-9befcced12ee09c2f4e1385d7e8e21c91f1a5a63b196f78f897c2d044b8c9312}
        PCRE2_VERSION: ${PCRE2_VERSION:-10.47}
        PCRE2_SHA256: ${PCRE2_SHA256:-c08ae2388ef333e8403e670ad70c0a11f1eed021fd88308d7e02f596fcd9dc16}
        ZLIB_COMMIT_SHA: ${ZLIB_COMMIT_SHA:-1252e2565573fe150897c9d8b44d3453396575ff}
        OPENSSL_VERSION: ${OPENSSL_VERSION:-3.6.0}
        OPENSSL_SHA256: ${OPENSSL_SHA256:-b6a5f44b7eb69e3fa35dbf15524405b44837a481d43d81daddde3ff21fcbb8e9}
    image: cmooreio/nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"

    # Security hardening
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
      - DAC_OVERRIDE

    # Writable tmpfs mounts for nginx operation
    tmpfs:
      - /var/cache/nginx/client_temp:uid=100,gid=101,mode=1700
      - /var/cache/nginx/proxy_temp:uid=100,gid=101,mode=1700
      - /var/cache/nginx/fastcgi_temp:uid=100,gid=101,mode=1700
      - /var/cache/nginx/uwsgi_temp:uid=100,gid=101,mode=1700
      - /var/cache/nginx/scgi_temp:uid=100,gid=101,mode=1700
      - /var/run:uid=100,gid=101,mode=1755
      - /tmp:uid=100,gid=101,mode=1777

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 128M

    # Health check (inherited from Dockerfile)
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

    # Restart policy
    restart: unless-stopped

    # Optional: Mount custom config
    # volumes:
    #   - ./nginx.conf:/etc/nginx/nginx.conf:ro
    #   - ./conf.d:/etc/nginx/conf.d:ro
    #   - ./html:/etc/nginx/html:ro
